{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h1>
<p class="text-gray-600 mb-8">Welcome, {{ user.username }}!</p>

{% if user.is_staff %}
    <!-- Admin Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Manage Rooms</h2>
            <a href="{% url 'rooms' %}" class="text-indigo-600 hover:underline">View & Add Rooms</a>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">View Bookings</h2>
            <p>{{ bookings.count }} active bookings.</p>
        </div>
         <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Recent Grievances</h2>
             <a href="{% url 'grievances' %}" class="text-indigo-600 hover:underline">View all grievances</a>
        </div>
    </div>
     <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Grievances Overview</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th class="py-2 px-4 border-b">Student</th>
                        <th class="py-2 px-4 border-b">Subject</th>
                        <th class="py-2 px-4 border-b">Status</th>
                        <th class="py-2 px-4 border-b">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for grievance in grievances %}
                    <tr>
                        <td class="py-2 px-4 border-b">{{ grievance.student.username }}</td>
                        <td class="py-2 px-4 border-b">{{ grievance.subject }}</td>
                        <td class="py-2 px-4 border-b">
                            <span id="status-{{ grievance.id }}" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                {% if grievance.status == 'Pending' %} bg-yellow-100 text-yellow-800 
                                {% elif grievance.status == 'In Progress' %} bg-blue-100 text-blue-800 
                                {% else %} bg-green-100 text-green-800 {% endif %}">
                                {{ grievance.status }}
                            </span>
                        </td>
                         <td class="py-2 px-4 border-b">
                            <select onchange="updateStatus({{ grievance.id }}, this.value)" class="bg-gray-200 rounded p-1">
                                <option value="Pending" {% if grievance.status == 'Pending' %}selected{% endif %}>Pending</option>
                                <option value="In Progress" {% if grievance.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                                <option value="Resolved" {% if grievance.status == 'Resolved' %}selected{% endif %}>Resolved</option>
                            </select>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-center py-4">No grievances found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% else %}
    <!-- Student Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">My Bookings</h2>
            {% for booking in bookings %}
            <p>Room: {{ booking.room.room_number }}</p>
            <p>From: {{ booking.start_date }} To: {{ booking.end_date }}</p>
            {% empty %}
            <p>No active bookings.</p>
            {% endfor %}
            <a href="{% url 'rooms' %}" class="mt-4 inline-block text-indigo-600 hover:underline">Book a Room</a>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">My Grievances</h2>
            <a href="{% url 'grievances' %}" class="text-indigo-600 hover:underline">View or Create Grievances</a>
        </div>
    </div>
     <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">My Grievance Status</h2>
        <div class="overflow-x-auto">
             <table class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th class="py-2 px-4 border-b">Subject</th>
                        <th class="py-2 px-4 border-b">Status</th>
                        <th class="py-2 px-4 border-b">Submitted On</th>
                    </tr>
                </thead>
                <tbody>
                    {% for grievance in grievances %}
                    <tr id="grievance-row-{{ grievance.id }}">
                        <td class="py-2 px-4 border-b">{{ grievance.subject }}</td>
                        <td class="py-2 px-4 border-b">
                            <span id="status-{{ grievance.id }}" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                {% if grievance.status == 'Pending' %} bg-yellow-100 text-yellow-800 
                                {% elif grievance.status == 'In Progress' %} bg-blue-100 text-blue-800 
                                {% else %} bg-green-100 text-green-800 {% endif %}">
                                {{ grievance.status }}
                            </span>
                        </td>
                        <td class="py-2 px-4 border-b">{{ grievance.created_at|date:"F d, Y" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function updateStatus(grievanceId, newStatus) {
        fetch(`/grievances/update/${grievanceId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const statusElement = document.getElementById(`status-${grievanceId}`);
                statusElement.textContent = newStatus;
                statusElement.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full'; // reset classes
                if (newStatus === 'Pending') {
                    statusElement.classList.add('bg-yellow-100', 'text-yellow-800');
                } else if (newStatus === 'In Progress') {
                    statusElement.classList.add('bg-blue-100', 'text-blue-800');
                } else {
                    statusElement.classList.add('bg-green-100', 'text-green-800');
                }
            } else {
                alert('Failed to update status.');
            }
        });
    }

    {% if not user.is_staff %}
    // Poll for status updates for students
    const grievanceIds = [{% for g in grievances %}{{ g.id }},{% endfor %}];
    
    function pollGrievanceStatuses() {
        grievanceIds.forEach(id => {
            fetch(`/grievances/status/${id}/`)
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.getElementById(`status-${id}`);
                    if (statusElement && statusElement.textContent.trim() !== data.status) {
                        statusElement.textContent = data.status;
                        statusElement.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full'; // reset classes
                        if (data.status === 'Pending') {
                            statusElement.classList.add('bg-yellow-100', 'text-yellow-800');
                        } else if (data.status === 'In Progress') {
                            statusElement.classList.add('bg-blue-100', 'text-blue-800');
                        } else {
                            statusElement.classList.add('bg-green-100', 'text-green-800');
                        }
                    }
                });
        });
    }

    if (grievanceIds.length > 0) {
        setInterval(pollGrievanceStatuses, 5000); // Poll every 5 seconds
    }
    {% endif %}
</script>
{% endblock %}
